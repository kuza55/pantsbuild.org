---
    authors: [Alex Kouzemtchenko]
    tags: []
---

# Building Linux/x64 containers on OS X on Apple Silicon with Pants

[Espresso AI](https://espresso.ai/) started as a primarily Linux shop, but as we've added more developers on OS X we've needed a way to build docker containers on OS X that are compatible with our Linux production environment.

Pants has supported running portions of the build in docker containers for [a while](https://www.pantsbuild.org/blog/2023/02/24/pants-2-15), but the exact configuration is a little tricky, particularly if you want to build x86_64 containers on Apple ARM processors.

The recipe itself is very straight foward, adding these two sections to your root BUILD and pants.toml files:

```bash title="BUILD"
__defaults__({
  pex_binary: dict(environment="linux"),
  docker_image: dict(build_platform=["linux/amd64"]),
})

local_environment(
  name="local_linux",
  compatible_platforms=["linux_x86_64"],
  fallback_environment="docker",
  docker_env_vars=["AWS_PROFILE=profile"]
)

local_environment(
  name="local_osx",
  compatible_platforms=["macos_arm64"],
)

docker_environment(
  name="docker",
  platform="linux_x86_64",
  image="python:3.11-bookworm",
  docker_env_vars=["AWS_PROFILE=profile"]
)
```


```bash title="pants.toml"
[environments-preview.names]
local = "//:local_linux"
local_osx = "//:local_osx"
docker = "//:docker"
```

With these snippets, we have defined 3 environments:
 * A docker environment with associated image for running the linux builds
 * A local linux environment that falls back to docker
 * An OSX environment for running non-linux builds & other goals locally on osx

We've setup a few defaults for our repo to avoid unnecessary configuration in our BUILD files:
 * All of our pex_binary targets are built using either the local or docker linux environments via the fallback mechanism
 * Explicitly specified the plaform of all our docker_image targets so that we do not inherit the platform defaults to builx linux/arm64 images.

The other targets get built/run using one of the maching local_workspace targets.

We've also worked around a non-obvious requirement to duplicate our [docker.env_vars] setting in the docker_env_vars field of the docker_environment target. If your publish of a docker container is failing, this is likely the cause.